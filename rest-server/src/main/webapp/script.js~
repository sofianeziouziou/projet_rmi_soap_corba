let currentUser = null;

function showTab(tab) {
    document.querySelectorAll('.tab-content').forEach(div => div.style.display = 'none');
    document.getElementById(tab + '-tab').style.display = 'block';
}

function showMessage(id, msg, type='') {
    const el = document.getElementById(id);
    el.innerText = msg;
    setTimeout(() => el.innerText = '', 4000);
}

// Connexion
async function login() {
    const email = document.getElementById('login-email').value;
    const password = document.getElementById('login-password').value;
    if(!email || !password) { showMessage('login-message', 'Remplir tous les champs'); return; }

    const res = await fetch('/users/login', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({email, password})
    });

    if(res.ok){
        currentUser = await res.json();
        document.getElementById('currentUser').style.display = 'block';
        document.getElementById('userName').innerText = currentUser.nom;
        document.getElementById('userRole').innerText = currentUser.role;
        showMessage('login-message', 'Connecté avec succès !');
        showTab('users');
    } else {
        const err = await res.json();
        showMessage('login-message', err.error || 'Erreur connexion');
    }
}

// Inscription
async function register() {
    const nom = document.getElementById('register-nom').value;
    const email = document.getElementById('register-email').value;
    const password = document.getElementById('register-password').value;
    const role = document.getElementById('register-role').value;

    if(!nom || !email || !password) { showMessage('register-message', 'Remplir tous les champs'); return; }

    const res = await fetch('/users/register', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({nom,email,password,role})
    });

    if(res.ok){
        showMessage('register-message', 'Inscription réussie ! Connectez-vous.');
        setTimeout(() => showTab('login'), 1500);
    } else {
        const err = await res.json();
        showMessage('register-message', err.error || 'Erreur inscription');
    }
}

// Déconnexion
function logout() {
    currentUser = null;
    document.getElementById('currentUser').style.display = 'none';
    showTab('login');
}

// Liste utilisateurs
async function loadUsers() {
    const res = await fetch('/users');
    if(res.ok){
        const users = await res.json();
        const container = document.getElementById('users-list');
        container.innerHTML = '';
        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'user-card';
            div.innerText = `${u.nom} (${u.role}) - ${u.email}`;
            container.appendChild(div);
        });
    } else {
        const err = await res.json();
        showMessage('users-list', err.error || 'Erreur chargement');
    }
}
