<!DOCTYPE html> <html lang="fr"> <head> <meta charset="UTF-8"> <title>Contrat - Immobilier</title> <link rel="stylesheet" href="style.css"> </head> <body> <div class="container"> <div id="currentUser" style="display:none;"> ConnectÃ© : <strong id="userName"></strong> (<span id="userRole"></span>) <button onclick="logout()" style="float:right;">DÃ©connexion</button> </div> <h1>Contrat</h1> <div id="contract-result"></div> <button id="buy-btn">Acheter</button> </div> <script src="shared.js"></script> <script> document.addEventListener("DOMContentLoaded", () => { if(!currentUser) { alert("Connectez-vous"); window.location.href="login.html"; return; } document.getElementById('currentUser').style.display='block'; document.getElementById('userName').textContent=currentUser.nom; document.getElementById('userRole').textContent=currentUser.role; const bienId = localStorage.getItem("selectedBien"); document.getElementById('buy-btn').addEventListener("click", () => acheterBien(bienId)); }); </script> </body> </html>async function acheterBien(bienId) { if (!confirm('ÃŠtes-vous sÃ»r de vouloir acheter ce bien ?')) return; try { console.log('ğŸ›’ Achat bien:', bienId, 'par', currentUser.id); const response = await fetch(${API_BASE}/acheterBien, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ bienId: parseInt(bienId), acheteurId: parseInt(currentUser.id) }) }); const data = await response.json(); console.log('ğŸ“¥ RÃ©ponse:', data); if (response.ok && data.success) { alert(âœ… Achat rÃ©ussi !\nContrat NÂ°${data.contractId}\nMontant: ${data.montant.toFixed(2)} â‚¬); // Mettre Ã  jour immÃ©diatement le bien dans la liste front const card = document.querySelector(.btn-acheter[onclick="acheterBien(${bienId})"]); if (card) { card.disabled = true; card.textContent = 'âœ— Vendu'; card.classList.remove('btn-acheter'); card.classList.add('badge-vendu'); } // Recharger les biens et notifications loadBiens(); } else { const errorMsg = data.error === 'bien_not_found' ? 'Bien introuvable' : data.error === 'bien_not_available' ? 'Ce bien n\'est plus disponible' : data.error || 'Erreur inconnue'; alert('âŒ Erreur: ' + errorMsg); } } catch (error) { console.error('âŒ Erreur:', error); alert('âŒ Impossible de se connecter au serveur'); } }