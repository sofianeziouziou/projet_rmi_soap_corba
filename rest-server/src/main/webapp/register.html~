<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Syst√®me Immobilier Distribu√©</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; }
        .container { max-width: 600px; margin: auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; text-align: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #e0e0e0; }
        .tabs button { padding: 10px 20px; border: none; background: none; cursor: pointer; font-size: 16px; }
        .tabs button:hover { background: #f5f5f5; }
        .tabs button.active { border-bottom: 3px solid #007bff; color: #007bff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        input, select { display: block; margin-bottom: 15px; width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        button.action { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; }
        button.action:hover { background: #0056b3; }
        .message { padding: 10px; margin-bottom: 15px; border-radius: 5px; }
        .message.success { background: #d4edda; color: #155724; }
        .message.error { background: #f8d7da; color: #721c24; }
        #currentUser { padding: 10px; background: #e7f3ff; border-radius: 5px; margin-bottom: 15px; }
        .user-card { padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; background: #fafafa; }
    </style>
</head>
<body>
<div class="container">
    <h1>üè† Syst√®me Immobilier Distribu√©</h1>

    <div id="currentUser" style="display:none;">
        Connect√© : <strong><span id="userName"></span></strong> (<span id="userRole"></span>)
        <button onclick="logout()" style="float:right; padding: 5px 10px;">D√©connexion</button>
    </div>

    <div class="tabs">
        <button onclick="showTab('login')" id="tab-login">Connexion</button>
        <button onclick="showTab('register')" id="tab-register">Inscription</button>
        <button onclick="showTab('users')" id="tab-users">Utilisateurs</button>
    </div>

    <!-- Connexion -->
    <div id="login-tab" class="tab-content active">
        <h2>Connexion</h2>
        <div id="login-message"></div>
        <input type="email" id="login-email" placeholder="Email" required>
        <input type="password" id="login-password" placeholder="Mot de passe" required>
        <button class="action" onclick="login()">Se connecter</button>
    </div>

    <!-- Inscription -->
    <div id="register-tab" class="tab-content">
        <h2>Inscription</h2>
        <div id="register-message"></div>
        <input type="text" id="register-nom" placeholder="Nom complet" required>
        <input type="email" id="register-email" placeholder="Email" required>
        <input type="password" id="register-password" placeholder="Mot de passe" required>
        <select id="register-role">
            <option value="acheteur">Acheteur</option>
            <option value="agent">Agent</option>
        </select>
        <button class="action" onclick="register()">S'inscrire</button>
    </div>

    <!-- Liste utilisateurs -->
    <div id="users-tab" class="tab-content">
        <h2>Liste des utilisateurs</h2>
        <button class="action" onclick="loadUsers()">üîÑ Actualiser</button>
        <div id="users-list"></div>
    </div>
</div>

<script>
    let currentUser = null;

    function showTab(tab) {
        document.querySelectorAll('.tab-content').forEach(div => div.classList.remove('active'));
        document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));

        document.getElementById(tab + '-tab').classList.add('active');
        document.getElementById('tab-' + tab).classList.add('active');
    }

    function showMessage(id, msg, type='error') {
        const el = document.getElementById(id);
        el.innerHTML = `<div class="message ${type}">${msg}</div>`;
        setTimeout(() => el.innerHTML = '', 4000);
    }

    async function login() {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        if(!email || !password) {
            showMessage('login-message', 'Veuillez remplir tous les champs');
            return;
        }

        try {
            const res = await fetch('/users/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, password})
            });

            if(res.ok){
                currentUser = await res.json();
                document.getElementById('currentUser').style.display = 'block';
                document.getElementById('userName').innerText = currentUser.nom;
                document.getElementById('userRole').innerText = currentUser.role;
                showMessage('login-message', 'Connect√© avec succ√®s !', 'success');
                setTimeout(() => showTab('users'), 1000);
            } else {
                showMessage('login-message', 'Email ou mot de passe incorrect');
            }
        } catch(e) {
            showMessage('login-message', 'Erreur de connexion au serveur');
        }
    }

    async function register() {
        const nom = document.getElementById('register-nom').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const role = document.getElementById('register-role').value;

        if(!nom || !email || !password) {
            showMessage('register-message', 'Veuillez remplir tous les champs');
            return;
        }

        try {
            const res = await fetch('/users/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({nom,email,password,role})
            });

            if(res.ok){
                showMessage('register-message', 'Inscription r√©ussie ! Connectez-vous.', 'success');
                setTimeout(() => showTab('login'), 1500);
            } else {
                const err = await res.json();
                showMessage('register-message', err.error === 'exists' ? 'Cet email est d√©j√† utilis√©' : 'Erreur lors de l\'inscription');
            }
        } catch(e) {
            showMessage('register-message', 'Erreur de connexion au serveur');
        }
    }

    function logout() {
        currentUser = null;
        document.getElementById('currentUser').style.display = 'none';
        showTab('login');
    }

    async function loadUsers() {
        try {
            const res = await fetch('/users');
            if(res.ok){
                const users = await res.json();
                const container = document.getElementById('users-list');
                container.innerHTML = '<h3>Total: ' + users.length + ' utilisateurs</h3>';

                users.forEach(u => {
                    const div = document.createElement('div');
                    div.className = 'user-card';
                    div.innerHTML = `
                        <strong>${u.nom}</strong><br>
                        Email: ${u.email}<br>
                        R√¥le: <span style="color: ${u.role === 'agent' ? '#007bff' : '#28a745'}">${u.role}</span>
                    `;
                    container.appendChild(div);
                });
            } else {
                showMessage('users-list', 'Erreur lors du chargement');
            }
        } catch(e) {
            showMessage('users-list', 'Erreur de connexion au serveur');
        }
    }

    // Charger les utilisateurs au d√©marrage si on est sur l'onglet
    if(window.location.hash === '#users') {
        showTab('users');
        loadUsers();
    }
</script>
</body>
</html>